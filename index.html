<!DOCTYPE html><html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>سوق مبوّب — اعرض منتجك وخدمتك</title>
  <meta name="description" content="موقع مبوّبة إعلانات بسيط بملف واحد. نشر إعلانات، بحث، تصفية، مفضلة، وإدارة عبر التخزين المحلي."/>
  <style>
    :root{
      --bg:#0f172a;/*slate-900*/
      --card:#111827;/*gray-900*/
      --muted:#94a3b8;/*slate-400*/
      --text:#e5e7eb;/*gray-200*/
      --brand:#22c55e;/*green-500*/
      --brand-2:#06b6d4;/*cyan-500*/
      --danger:#ef4444;/*red-500*/
      --warn:#f59e0b;/*amber-500*/
      --radius:18px;
      --shadow:0 8px 30px rgba(0,0,0,.25);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Noto Kufi Arabic, "Noto Naskh Arabic", Tahoma, Arial, sans-serif; 
      background:linear-gradient(180deg, #0b1225 0%, var(--bg) 60%);
      color:var(--text);
    }
    a{color:inherit}
    .container{max-width:1150px;margin:0 auto;padding:18px}
    header{position:sticky;top:0;backdrop-filter:blur(8px);background:rgba(15,23,42,.75);border-bottom:1px solid rgba(255,255,255,.06);z-index:50}
    .brand{display:flex;align-items:center;gap:10px}
    .logo{width:40px;height:40px;border-radius:12px;background:linear-gradient(135deg,var(--brand),var(--brand-2));display:grid;place-items:center;box-shadow:var(--shadow)}
    .logo span{font-weight:800;color:#04110a}
    .hstack{display:flex;gap:10px;align-items:center}
    .spacer{flex:1}
    button,select,input,textarea{border-radius:12px;border:1px solid rgba(255,255,255,.08);background:#0b1223;color:var(--text);padding:10px 12px}
    button{cursor:pointer;transition:.2s transform ease, .2s opacity ease}
    button:hover{transform:translateY(-2px)}
    .btn{background:linear-gradient(135deg,#16a34a,#059669);border:none}
    .btn-outline{background:transparent;border:1px solid var(--brand)}
    .btn-danger{background:linear-gradient(135deg,#ef4444,#b91c1c);border:none}
    .toolbar{display:grid;grid-template-columns:1.2fr .9fr .9fr .8fr .6fr auto;gap:10px;margin-top:12px}
    .cards{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:16px;margin:18px 0}
    @media (max-width:900px){.cards{grid-template-columns:repeat(2,1fr)}.toolbar{grid-template-columns:1fr 1fr;grid-auto-rows:auto}}
    @media (max-width:620px){.cards{grid-template-columns:1fr}.toolbar{grid-template-columns:1fr}}
    .card{background:linear-gradient(180deg,#0f162e 0%, #0c1326 100%);border:1px solid rgba(255,255,255,.06);border-radius:var(--radius);overflow:hidden;box-shadow:var(--shadow);display:flex;flex-direction:column}
    .cover{position:relative;width:100%;aspect-ratio:16/10;background:#030712}
    .cover img{position:absolute;inset:0;width:100%;height:100%;object-fit:cover}
    .chip{position:absolute;left:10px;top:10px;background:rgba(15,23,42,.85);padding:6px 10px;border-radius:999px;font-size:12px;border:1px solid rgba(255,255,255,.08)}
    .card-body{padding:12px}
    .title{font-weight:700;font-size:17px;line-height:1.4;margin:4px 0 8px}
    .muted{color:var(--muted);font-size:13px}
    .price{font-size:18px;font-weight:800;background:linear-gradient(135deg,#a7f3d0,#67e8f9);-webkit-background-clip:text;background-clip:text;color:transparent}
    .grid{display:grid;gap:10px}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .badges{display:flex;gap:6px;flex-wrap:wrap}
    .badge{font-size:12px;padding:6px 8px;border-radius:999px;border:1px solid rgba(255,255,255,.08);background:#0b1223}
    .footer{display:flex;align-items:center;gap:10px;margin-top:auto;padding:12px;border-top:1px solid rgba(255,255,255,.06)}
    .footer .spacer{flex:1}
    .empty{opacity:.75;text-align:center;padding:40px;border:1px dashed rgba(255,255,255,.2);border-radius:var(--radius)}dialog{border:none;border-radius:18px;max-width:920px;width:96%;background:#0b1223;color:var(--text);box-shadow:var(--shadow)}
dialog::backdrop{background:rgba(2,6,23,.7)}
.modal-header{display:flex;gap:10px;align-items:center;justify-content:space-between;padding:12px 16px;border-bottom:1px solid rgba(255,255,255,.06)}
.modal-body{padding:16px}
.form-grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px}
.form-grid-3{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:10px}
@media (max-width:720px){.form-grid{grid-template-columns:1fr}.form-grid-3{grid-template-columns:1fr}}
textarea{min-height:110px;resize:vertical}
.gallery{display:flex;gap:8px;overflow:auto}
.thumb{width:92px;height:68px;border-radius:10px;border:1px solid rgba(255,255,255,.08);overflow:hidden;position:relative}
.thumb img{width:100%;height:100%;object-fit:cover}
.x{position:absolute;inset:auto 6px 6px auto;background:rgba(0,0,0,.55);border-radius:8px;border:1px solid rgba(255,255,255,.1);padding:2px 6px;font-size:12px;cursor:pointer}

/* View modal */
.view{display:grid;grid-template-columns:1.2fr .8fr;gap:16px}
@media (max-width:860px){.view{grid-template-columns:1fr}}
.carousel{position:relative;border-radius:16px;overflow:hidden;border:1px solid rgba(255,255,255,.08)}
.carousel img{width:100%;height:360px;object-fit:cover;background:#030712}
.navbtn{position:absolute;top:50%;transform:translateY(-50%);background:rgba(2,6,23,.6);border:1px solid rgba(255,255,255,.12);padding:8px 10px;border-radius:10px;cursor:pointer}
.navbtn.prev{right:10px}
.navbtn.next{left:10px}
.panel{background:#0b1223;border:1px solid rgba(255,255,255,.06);padding:14px;border-radius:16px}
.panel h3{margin:0 0 8px}
.alert{padding:10px;border:1px solid rgba(255,255,255,.12);border-radius:12px;background:#0c1a2f}

  </style>
</head>
<body>
  <header>
    <div class="container hstack">
      <div class="brand">
        <div class="logo"><span>س</span></div>
        <div>
          <div style="font-weight:800">سوق مبوّب</div>
          <div class="muted" style="font-size:12px">اعرض منتجاتك وخدماتك بسهولة</div>
        </div>
      </div>
      <div class="spacer"></div>
      <button class="btn" id="btn-new">+ إعلان جديد</button>
      <button id="btn-export" title="تصدير النسخة الاحتياطية">تصدير</button>
      <label for="importFile" class="btn-outline" style="cursor:pointer">استيراد</label>
      <input id="importFile" type="file" accept="application/json" style="display:none" />
    </div>
    <div class="container toolbar">
      <input id="q" placeholder="ابحث باسم الإعلان أو الوصف…" />
      <select id="cat"></select>
      <select id="city"></select>
      <select id="sort">
        <option value="new">الأحدث</option>
        <option value="price_asc">السعر: من الأقل للأعلى</option>
        <option value="price_desc">السعر: من الأعلى للأقل</option>
        <option value="views">الأكثر مشاهدة</option>
      </select>
      <input id="maxPrice" type="number" placeholder="حدّ أقصى للسعر" />
      <button id="btn-clear" class="btn-outline">مسح الفلاتر</button>
    </div>
  </header>  <main class="container">
    <div id="stats" class="row muted" style="margin-top:10px"></div>
    <div id="cards" class="cards"></div>
    <div id="empty" class="empty" style="display:none">لا توجد إعلانات بعد. ابدأ بإنشاء إعلانك من الزر بالأعلى ✨</div>
  </main>  <!-- Create/Edit Modal -->  <dialog id="adModal">
    <form method="dialog" id="adForm">
      <div class="modal-header">
        <b id="modalTitle">إعلان جديد</b>
        <button id="closeModal">إغلاق</button>
      </div>
      <div class="modal-body">
        <div class="form-grid">
          <div class="grid">
            <label>عنوان الإعلان
              <input id="title" required maxlength="80" placeholder="مثال: آيفون 13 برو حالة ممتازة" />
            </label>
            <div class="form-grid-3">
              <label>الفئة
                <select id="category" required></select>
              </label>
              <label>السعر (ج.م)
                <input id="price" type="number" min="0" step="1" required />
              </label>
              <label>المدينة
                <select id="cityInput" required></select>
              </label>
            </div>
            <label>الوصف
              <textarea id="description" maxlength="1200" placeholder="أضف تفاصيل واضحة عن الحالة والمرفقات…"></textarea>
            </label>
            <label>صور الإعلان (حتى 8 صور)
              <input id="images" type="file" accept="image/*" multiple />
            </label>
            <div class="gallery" id="thumbs"></div>
          </div>
          <div class="grid">
            <div class="panel">
              <h3>معلومات التواصل</h3>
              <label>اسم المعلن
                <input id="name" placeholder="اسمك" />
              </label>
              <label>رقم الهاتف
                <input id="phone" placeholder="01XXXXXXXXX" />
              </label>
              <label>واتساب (اختياري)
                <input id="whatsapp" placeholder="01XXXXXXXXX" />
              </label>
              <div class="alert muted" style="margin-top:8px">لن نعرض رقمك علنًا إلا داخل صفحة الإعلان.</div>
            </div>
            <div class="row" style="margin-top:auto;justify-content:flex-end">
              <button class="btn" id="saveAd">حفظ الإعلان</button>
            </div>
          </div>
        </div>
      </div>
    </form>
  </dialog>  <!-- View Modal -->  <dialog id="viewModal">
    <div class="modal-header">
      <b id="viewTitle">تفاصيل الإعلان</b>
      <button id="closeView">إغلاق</button>
    </div>
    <div class="modal-body view">
      <div>
        <div class="carousel">
          <img id="viewImage" alt="صورة الإعلان" />
          <button class="navbtn prev" id="prevImg">⟨</button>
          <button class="navbtn next" id="nextImg">⟩</button>
        </div>
        <div class="badges" style="margin-top:10px">
          <span class="badge" id="viewCat"></span>
          <span class="badge" id="viewCity"></span>
          <span class="badge" id="viewDate"></span>
          <span class="badge" id="viewViews"></span>
          <span class="badge" id="viewStatus"></span>
        </div>
        <h2 class="title" id="viewHeader"></h2>
        <div class="price" id="viewPrice"></div>
        <p class="muted" id="viewDesc" style="white-space:pre-wrap"></p>
      </div>
      <div class="grid">
        <div class="panel">
          <h3>تواصل مع المعلن</h3>
          <div id="viewContact" class="grid" style="gap:8px"></div>
          <div class="row" style="margin-top:8px">
            <button id="btnMarkSold" class="btn-outline">تحديد كمباع</button>
            <button id="btnEdit" class="btn">تعديل</button>
            <button id="btnDelete" class="btn-danger">حذف</button>
          </div>
        </div>
        <div class="panel">
          <h3>مشاركة الإعلان</h3>
          <div class="grid">
            <button id="btnCopyLink">نسخ رابط مباشر</button>
            <small class="muted">يتم إنشاء رابط بمعرّف الإعلان داخل العنوان (URL Hash).</small>
          </div>
        </div>
      </div>
    </div>
  </dialog>  <script>
  // ======== بيانات أساسية ========
  const CATS = ["موبايلات","الكترونيات","عقارات","وظائف","سيارات","خدمات","أثاث","أخرى"];
  const CITIES = ["القاهرة","الجيزة","الإسكندرية","أسوان","الأقصر","أسيوط","سوهاج","قنا","البحيرة","الشرقية","الغربية","الدقهلية","دمياط","الإسماعيلية","السويس","مطروح","كفر الشيخ","المنوفية","المنيا","بني سويف","الفيوم","بورسعيد","قاهرة أخرى"];

  // ======== حالة التطبيق والتخزين ========
  const state = {
    ads: [],
    q: "",
    cat: "الكل",
    city: "الكل",
    sort: "new",
    maxPrice: "",
    currentView: null,
    carouselIndex: 0,
    userId: getOrCreateUserId()
  };

  function getOrCreateUserId(){
    let id = localStorage.getItem("sb_userId");
    if(!id){ id = "u_"+Math.random().toString(36).slice(2); localStorage.setItem("sb_userId", id); }
    return id;
  }

  function save(){ localStorage.setItem("sb_ads", JSON.stringify(state.ads)); }
  function load(){ state.ads = JSON.parse(localStorage.getItem("sb_ads")||"[]"); }

  // ======== أدوات مساعدة ========
  const $ = sel => document.querySelector(sel);
  function fmtPrice(n){ if(n==null||n==="") return "—"; return new Intl.NumberFormat('ar-EG').format(Number(n))+" ج.م" }
  function timeAgo(ts){
    const d = new Date(ts), now = new Date();
    const s = Math.floor((now-d)/1000); if(s<60) return "الآن";
    const m = Math.floor(s/60); if(m<60) return m+" د";
    const h = Math.floor(m/60); if(h<24) return h+" س";
    const days = Math.floor(h/24); if(days<30) return days+" يوم";
    const months = Math.floor(days/30); if(months<12) return months+" ش";
    const years = Math.floor(months/12); return years+" سنة";
  }
  function uid(){ return "ad_"+Math.random().toString(36).slice(2) }

  // ======== تهيئة القوائم ========
  function initSelects(){
    const cat = $('#cat');
    cat.innerHTML = '<option value="الكل">كل الفئات</option>' + CATS.map(c=>`<option>${c}</option>`).join('');
    const category = $('#category');
    category.innerHTML = CATS.map(c=>`<option>${c}</option>`).join('');

    const city = $('#city');
    city.innerHTML = '<option value="الكل">كل المدن</option>' + CITIES.map(c=>`<option>${c}</option>`).join('');
    const cityInput = $('#cityInput');
    cityInput.innerHTML = CITIES.map(c=>`<option>${c}</option>`).join('');
  }

  // ======== رفع الصور مع ضغط بسيط ========
  async function filesToDataURLs(files){
    const list = [];
    for(const file of files){
      const data = await readFileAsDataURL(file);
      const small = await resizeImage(data, 1200);
      list.push(small);
    }
    return list.slice(0,8);
  }
  function readFileAsDataURL(file){
    return new Promise(res=>{ const fr=new FileReader(); fr.onload=e=>res(e.target.result); fr.readAsDataURL(file) })
  }
  function resizeImage(dataUrl, maxW){
    return new Promise(res=>{
      const img = new Image();
      img.onload = ()=>{
        const ratio = img.width>maxW ? maxW/img.width : 1;
        const canvas = document.createElement('canvas');
        canvas.width = Math.round(img.width*ratio);
        canvas.height = Math.round(img.height*ratio);
        const ctx=canvas.getContext('2d');
        ctx.drawImage(img,0,0,canvas.width,canvas.height);
        res(canvas.toDataURL('image/jpeg', .85));
      };
      img.src = dataUrl;
    })
  }

  // ======== عرض البطاقات ========
  function applyFilters(){
    let list = [...state.ads];
    const q = state.q.trim();
    if(q){ const qq=q.toLowerCase(); list = list.filter(a=> (a.title+a.description).toLowerCase().includes(qq)) }
    if(state.cat!=="الكل") list = list.filter(a=>a.category===state.cat);
    if(state.city!=="الكل") list = list.filter(a=>a.city===state.city);
    if(state.maxPrice) list = list.filter(a=>Number(a.price) <= Number(state.maxPrice));
    switch(state.sort){
      case 'price_asc': list.sort((a,b)=>a.price-b.price); break;
      case 'price_desc': list.sort((a,b)=>b.price-a.price); break;
      case 'views': list.sort((a,b)=>b.views-a.views); break;
      default: list.sort((a,b)=>b.createdAt-a.createdAt);
    }
    return list;
  }
  function render(){
    const list = applyFilters();
    $('#stats').textContent = `عدد الإعلانات: ${state.ads.length} • المعروضة: ${list.length}`;
    const wrap = $('#cards');
    wrap.innerHTML = '';
    if(list.length===0){ $('#empty').style.display='block'; return } else { $('#empty').style.display='none' }
    for(const ad of list){
      const div = document.createElement('div');
      div.className='card';
      const img = ad.images && ad.images[0] ? `<img alt="${ad.title}" src="${ad.images[0]}">` : '';
      div.innerHTML = `
        <div class="cover">${img}<span class="chip">${ad.city}</span></div>
        <div class="card-body">
          <div class="title">${escapeHtml(ad.title)}</div>
          <div class="row"><span class="price">${fmtPrice(ad.price)}</span> <span class="muted">• ${ad.category}</span></div>
          <div class="muted">منذ ${timeAgo(ad.createdAt)} • ${ad.views} مشاهدة</div>
        </div>
        <div class="footer">
          <button data-action="view" class="btn" data-id="${ad.id}">عرض</button>
          <button data-action="fav" data-id="${ad.id}">${ad.fav? '★ مفضلة' : '☆ إضافة للمفضلة'}</button>
          <div class="spacer"></div>
          ${ad.ownerId===state.userId ? `<button data-action="edit" data-id="${ad.id}">تعديل</button>`:''}
        </div>
      `;
      wrap.appendChild(div);
    }
  }

  function escapeHtml(str){ return str.replace(/[&<>"]/g, s=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[s])) }

  // ======== إنشاء/تعديل إعلان ========
  const adModal = $('#adModal');
  const viewModal = $('#viewModal');
  let editingId = null;

  $('#btn-new').onclick = ()=>{ editingId=null; openAdModal() };
  $('#closeModal').onclick = ()=> adModal.close();

  function openAdModal(ad){
    $('#modalTitle').textContent = ad? 'تعديل إعلان' : 'إعلان جديد';
    $('#title').value = ad?.title || '';
    $('#category').value = ad?.category || CATS[0];
    $('#price').value = ad?.price ?? '';
    $('#cityInput').value = ad?.city || CITIES[0];
    $('#description').value = ad?.description || '';
    $('#name').value = ad?.contact?.name || '';
    $('#phone').value = ad?.contact?.phone || '';
    $('#whatsapp').value = ad?.contact?.whatsapp || '';
    drawThumbs(ad?.images||[]);
    adModal.showModal();
  }

  function drawThumbs(imgs){
    const box = $('#thumbs');
    box.innerHTML='';
    (imgs||[]).forEach((src,i)=>{
      const t = document.createElement('div');
      t.className='thumb';
      t.innerHTML = `<img src="${src}"><span class="x" data-index="${i}">✕</span>`;
      box.appendChild(t);
    })
  }

  const tempImages = [];
  $('#images').addEventListener('change', async (e)=>{
    const files = e.target.files; if(!files?.length) return;
    const list = await filesToDataURLs(files);
    tempImages.push(...list);
    drawThumbs(tempImages);
  });
  $('#thumbs').addEventListener('click', (e)=>{
    if(e.target.classList.contains('x')){
      const i = Number(e.target.dataset.index);
      tempImages.splice(i,1);
      drawThumbs(tempImages);
    }
  })

  $('#saveAd').onclick = (e)=>{
    e.preventDefault();
    const ad = {
      id: editingId || uid(),
      title: $('#title').value.trim(),
      category: $('#category').value,
      price: Number($('#price').value||0),
      city: $('#cityInput').value,
      description: $('#description').value.trim(),
      images: (editingId? (tempImages.length? tempImages: currentEditingImages): tempImages).slice(0,8),
      contact: { name: $('#name').value, phone: $('#phone').value, whatsapp: $('#whatsapp').value },
      ownerId: state.userId,
      status: editingId? (state.ads.find(a=>a.id===editingId)?.status || 'متاح') : 'متاح',
      views: editingId? (state.ads.find(a=>a.id===editingId)?.views || 0) : 0,
      createdAt: editingId? (state.ads.find(a=>a.id===editingId)?.createdAt || Date.now()) : Date.now(),
      fav: editingId? (state.ads.find(a=>a.id===editingId)?.fav || false) : false
    };
    if(!ad.title){ alert('الرجاء إدخال عنوان'); return }
    if(!ad.price){ if(!confirm('لم تحدد سعرًا. المتابعة؟')) return }
    if(editingId){
      const i = state.ads.findIndex(a=>a.id===editingId);
      state.ads[i] = ad;
    } else {
      state.ads.unshift(ad);
    }
    save();
    adModal.close();
    tempImages.length=0; currentEditingImages=[]; editingId=null;
    render();
  }

  let currentEditingImages = [];

  // ======== أحداث القائمة ========
  $('#q').oninput = debounce(()=>{ state.q = $('#q').value; render() }, 250);
  $('#cat').onchange = ()=>{ state.cat = $('#cat').value; render() };
  $('#city').onchange = ()=>{ state.city = $('#city').value; render() };
  $('#sort').onchange = ()=>{ state.sort = $('#sort').value; render() };
  $('#maxPrice').oninput = ()=>{ state.maxPrice = $('#maxPrice').value; render() };
  $('#btn-clear').onclick = ()=>{ state.q=''; state.cat='الكل'; state.city='الكل'; state.sort='new'; state.maxPrice=''; $('#q').value=''; $('#cat').value='الكل'; $('#city').value='الكل'; $('#sort').value='new'; $('#maxPrice').value=''; render() };

  // ======== عرض إعلان ========
  $('#cards').addEventListener('click', (e)=>{
    const btn = e.target.closest('button'); if(!btn) return;
    const id = btn.dataset.id; const ad = state.ads.find(a=>a.id===id);
    if(btn.dataset.action==='view'){ openView(ad) }
    if(btn.dataset.action==='fav'){ ad.fav=!ad.fav; save(); render() }
    if(btn.dataset.action==='edit'){ editingId=id; currentEditingImages=[...(ad.images||[])]; openAdModal(ad) }
  })

  function openView(ad){
    state.currentView = ad;
    ad.views = (ad.views||0)+1; save();
    $('#viewHeader').textContent = ad.title;
    $('#viewTitle').textContent = ad.title;
    $('#viewPrice').textContent = fmtPrice(ad.price);
    $('#viewDesc').textContent = ad.description || '—';
    $('#viewCat').textContent = ad.category;
    $('#viewCity').textContent = ad.city;
    $('#viewViews').textContent = ad.views+" مشاهدة";
    $('#viewDate').textContent = 'منذ '+timeAgo(ad.createdAt);
    $('#viewStatus').textContent = ad.status;
    state.carouselIndex = 0;
    drawCarousel();
    const contactBox = $('#viewContact');
    contactBox.innerHTML = '';
    if(ad.contact?.name) contactBox.innerHTML += `<div class="muted">الاسم: ${escapeHtml(ad.contact.name)}</div>`;
    if(ad.contact?.phone) contactBox.innerHTML += `<a class="btn" href="tel:${ad.contact.phone}">اتصال هاتفي</a>`;
    if(ad.contact?.whatsapp) contactBox.innerHTML += `<a class="btn-outline" target="_blank" href="https://wa.me/2${ad.contact.whatsapp}">مراسلة واتساب</a>`;
    $('#btnMarkSold').style.display = ad.ownerId===state.userId? 'inline-block' : 'none';
    $('#btnEdit').style.display = ad.ownerId===state.userId? 'inline-block' : 'none';
    $('#btnDelete').style.display = ad.ownerId===state.userId? 'inline-block' : 'none';
    viewModal.showModal();
    // ضع المعرّف في العنوان ليصبح الرابط قابلاً للمشاركة
    history.replaceState(null, '', location.pathname + '#'+ad.id);
  }

  function drawCarousel(){
    const ad = state.currentView; const img = $('#viewImage');
    if(!ad.images?.length){ img.removeAttribute('src'); img.alt='لا صور'; return }
    img.src = ad.images[state.carouselIndex];
  }
  $('#prevImg').onclick = ()=>{ const ad = state.currentView; if(!ad?.images?.length) return; state.carouselIndex = (state.carouselIndex-1+ad.images.length)%ad.images.length; drawCarousel(); };
  $('#nextImg').onclick = ()=>{ const ad = state.currentView; if(!ad?.images?.length) return; state.carouselIndex = (state.carouselIndex+1)%ad.images.length; drawCarousel(); };

  $('#closeView').onclick = ()=>{ viewModal.close(); history.replaceState(null,'',location.pathname) };
  $('#btnEdit').onclick = ()=>{ const ad=state.currentView; editingId=ad.id; currentEditingImages=[...(ad.images||[])]; viewModal.close(); openAdModal(ad) };
  $('#btnDelete').onclick = ()=>{ const ad=state.currentView; if(confirm('حذف الإعلان نهائيًا؟')){ state.ads = state.ads.filter(a=>a.id!==ad.id); save(); viewModal.close(); render(); history.replaceState(null,'',location.pathname) } };
  $('#btnMarkSold').onclick = ()=>{ const ad=state.currentView; ad.status = ad.status==='متاح'? 'مباع' : 'متاح'; save(); $('#viewStatus').textContent=ad.status; render(); };
  $('#btnCopyLink').onclick = async ()=>{
    const ad = state.currentView; const url = location.origin + location.pathname + '#'+ad.id;
    try{ await navigator.clipboard.writeText(url); alert('تم نسخ الرابط ✅'); }catch{ prompt('انسخ الرابط:', url) }
  };

  // ======== تصدير/استيراد ========
  $('#btn-export').onclick = ()=>{
    const data = JSON.stringify({ ads: state.ads }, null, 2);
    const blob = new Blob([data], {type:'application/json'});
    const a = document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='classifieds-backup.json'; a.click();
  };
  $('#importFile').onchange = async (e)=>{
    const file = e.target.files?.[0]; if(!file) return;
    const txt = await file.text();
    try{
      const json = JSON.parse(txt);
      if(Array.isArray(json.ads)){
        state.ads = json.ads; save(); render(); alert('تم الاستيراد بنجاح ✅');
      } else alert('ملف غير صالح');
    }catch(err){ alert('تعذّر قراءة الملف') }
    e.target.value = '';
  };

  // ======== دعم فتح إعلان من الرابط ========
  function openFromHash(){
    const id = location.hash.slice(1); if(!id) return;
    const ad = state.ads.find(a=>a.id===id); if(ad) openView(ad);
  }

  // ======== Debounce ========
  function debounce(fn, ms){ let t; return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn(...args),ms) } }

  // ======== بدء التشغيل ========
  function seedIfEmpty(){
    if(state.ads.length) return;
    const demo = [
      {title:'هاتف سامسونج A54',category:'موبايلات',price:9500,city:'القاهرة',description:'حالة ممتازة، مع العلبة والشاحن، استعمال خفيف.',images:[],contact:{name:'أحمد',phone:'01000000000',whatsapp:'01000000000'}},
      {title:'مهندس صيانة كهرباء',category:'خدمات',price:0,city:'الجيزة',description:'متخصص في صيانة المنازل والشركات، زيارة كشف مجانية.',images:[],contact:{name:'سعيد',phone:'01111111111'}},
      {title:'شقة للبيع 120م',category:'عقارات',price:1450000,city:'الإسكندرية',description:'قريبة من البحر، تشطيب سوبر لوكس.',images:[],contact:{name:'محمود',phone:'01222222222',whatsapp:'01222222222'}},
    ];
    state.ads = demo.map(d=>({id:uid(),createdAt:Date.now()-Math.random()*5*864e5,views:Math.floor(Math.random()*120),status:'متاح',ownerId:state.userId,fav:false,...d}));
    save();
  }

  function init(){
    initSelects();
    load();
    seedIfEmpty();
    render();
    openFromHash();
  }

  document.addEventListener('DOMContentLoaded', init);
  </script></body>
</html>
